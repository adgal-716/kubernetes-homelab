#Kubernetes Homelab (k3s-based)

This repository documents a high-availability Kubernetes homelab
implemented using k3s as the Kubernetes distribution.
It includes cluster infrastructure, networking, storage, and multiple
stateful applications deployed using standard Kubernetes manifests.

Although k3s is used for this implementation, all workloads rely on
vanilla Kubernetes APIs and can be migrated to other distributions
(EKS, GKE, AKS, kubeadm) with minimal changes.

------------------------------------------------------------------------

##Cluster Overview

The cluster is designed for high availability (HA) and resilience
in small-scale or on-premise environments.

###Current implementation:

	*3 control plane nodes

	*3 worker nodes

The architecture supports horizontal scaling by adding more worker nodes.

------------------------------------------------------------------------

##Architecture Components

	*High Availability Control Plane

		*3 k3s control plane nodes

		*Fault-tolerant Kubernetes control layer

	*Worker Nodes

		*Dedicated nodes for application workloads

	*MetalLB

		*Provides LoadBalancer-type services in bare-metal environments

		*Supports shared IP usage across multiple services

	*HAProxy (optional)

		*External or additional load balancer for ingress traffic

	*Persistent Storage (NFS)

		*External NFS server

		*Managed through an in-cluster NFS Provisioner

------------------------------------------------------------------------

##Repository Structure
	APPS/
	├── Geoserver
	├── Nextcloud
	├── PGbouncer
	└── ProvisionerNFS

	CLUSTER-CONF/
	HAPROXY-CLUSTER/


###Separation of concerns:

	*CLUSTER-CONF → core cluster infrastructure

	*HAPROXY-CLUSTER → optional external load balancing

	*APPS → application workloads and dependencies

------------------------------------------------------------------------

##Applications Overview

###Nextcloud
Self-hosted file sharing and collaboration platform.

Characteristics:
    *Uses Persistent Volumes via NFS
    *Exposed using MetalLB LoadBalancer service
    *Requires database connectivity via PGbouncer

Secrets are intentionally excluded from the repository.
Example secret manifests are provided under:

    APPS/Nextcloud/01-example-secret.yaml

#### Application URL Configuration

Some applications require an externally reachable URL
(e.g. `OVERWRITECLIURL`).

This is typically required when applications generate absolute URLs
or are accessed behind a LoadBalancer or ingress.

All URLs and hostnames defined in the manifests use **example values**
(e.g. `nextcloud.example.local`) and must be adjusted to match the
actual LoadBalancer IP, DNS name, or ingress configuration in the
target environment.

---

###Geoserver
Geospatial data server used to publish and manage GIS services.

Characteristics:
    *Uses Persistent Volumes for data storage
    *Exposed via LoadBalancer service
    *Requires external database credentials

---

###PGbouncer
Lightweight PostgreSQL connection pooler.

Characteristics:
    *Acts as an intermediary between applications and PostgreSQL
    *Deployed as a stateless service
    *Uses Secrets for database credentials

---

###ProvisionerNFS
In-cluster NFS dynamic provisioner.

Characteristics:
    *Provides dynamic PersistentVolumes
    *Backed by an external NFS server
    *Used by all stateful applications

------------------------------------------------------------------------

##MetalLB Configuration

MetalLB is used to provide LoadBalancer-type services in a bare-metal
Kubernetes environment.

###Shared IP Usage

All services exposed via LoadBalancer use the following annotation:

    metallb.universe.tf/allow-shared-ip: shared-ip

This allows multiple services to share a single external IP while using
different ports, optimizing IP address usage in MetalLB pools.

###IP Addressing

MetalLB is configured using a Layer 2 address pool defined in:

    CLUSTER-CONF/01-metallb-config.yaml

Example (non-production range):

    addresses:
      - 10.10.0.200-10.10.0.220

The IP ranges defined in this repository are **example private ranges**
used for documentation purposes only and must be adapted to match the
target environment’s network topology before deployment.

------------------------------------------------------------------------

##Deployment Order
	1. Cluster Base Configuration

	Includes MetalLB, storage classes, dashboard configuration, and
	administrative resources.

		kubectl apply -f CLUSTER-CONF/

	2. External Load Balancer (optional)

	Required only if HAProxy is part of the architecture.

		kubectl apply -f HAPROXY-CLUSTER/

	3. Applications (recommended order)

		NFS Provisioner

		kubectl apply -f APPS/ProvisionerNFS/


		PGbouncer

		kubectl apply -f APPS/PGbouncer/


		Geoserver

		kubectl apply -f APPS/Geoserver/


		Nextcloud

		kubectl apply -f APPS/Nextcloud/

------------------------------------------------------------------------

##Manifest Ordering Strategy

Manifests are prefixed numerically to ensure correct creation order,
as Kubernetes applies files alphabetically:

	01-secret.yaml
	02-pvc.yaml
	03-deployment.yaml
	04-service.yaml


This avoids race conditions where deployments depend on resources
(Secrets, PVCs) that do not yet exist.

##NFS Provisioner Dependency

The NFS Provisioner relies on an external NFS server defined in the
node’s /etc/hosts file:

	<NFS_SERVER_IP>   storage


Manifests reference the server using:

	server: storage


This approach allows the NFS server IP to be changed without modifying
any Kubernetes manifests—only the /etc/hosts entry needs updating.

------------------------------------------------------------------------

##Requirements

	*3 control plane nodes (HA)

	*1 or more worker nodes (current setup: 3)

	*k3s installed on all nodes

	*MetalLB configured with a valid IP range

	*External NFS server reachable from all nodes

	*HAProxy (optional)

------------------------------------------------------------------------

##Project Goals

This project aims to document a real-world Kubernetes homelab
implementation that emphasizes:

	*High availability in small environments

	*Clean and reproducible manifests

	*Separation of infrastructure and workloads

	*Practical Kubernetes patterns applicable to production systems

It serves both as a learning platform and a portable reference
for Kubernetes deployments beyond managed cloud services.

------------------------------------------------------------------------

##Notes on Security

	*No real credentials or tokens are stored in this repository

	*Secret manifests are provided as examples only

	*Sensitive data must be created locally before deployment

------------------------------------------------------------------------

##Why k3s?

k3s was chosen for its lightweight footprint and suitability for
bare-metal and homelab environments.
All manifests remain compatible with upstream Kubernetes.

------------------------------------------------------------------------

## CI/CD

This repository includes a CI pipeline that validates Kubernetes
manifests on every push and pull request, ensuring:

- YAML syntax correctness
- Kubernetes schema validation
- Early detection of misconfigurations

No automatic deployments are performed.
